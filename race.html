<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Race â€” Pixelon</title>
<link rel="icon" type="image/x-icon" href="icon.jpg">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Black+Ops+One&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:'Orbitron',sans-serif;overflow:hidden;width:100vw;height:100vh;touch-action:none}
canvas{display:block}
#gameCanvas{position:fixed;inset:0;width:100vw;height:100vh}

/* â”€â”€ SETUP â”€â”€ */
#setup{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;overflow-y:auto;padding:20px 20px 40px}
#setup h1{font-family:'Black Ops One',cursive;font-size:clamp(36px,7vw,72px);letter-spacing:3px;margin-bottom:4px}
.subtitle{font-size:11px;color:#555;letter-spacing:5px;margin-bottom:32px}
.card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:28px 36px;width:min(480px,92vw)}
.row{margin-bottom:22px}
.row label{display:block;font-size:10px;letter-spacing:3px;color:#666;margin-bottom:10px;text-transform:uppercase}
.segs{display:flex;gap:7px;flex-wrap:wrap}
.seg{flex:1;min-width:44px;padding:9px 4px;background:transparent;border:1px solid #333;color:#666;border-radius:7px;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:11px;transition:all .18s}
.seg.on{border-color:#fff;color:#fff;background:rgba(255,255,255,0.09)}
.swatches{display:flex;gap:9px;flex-wrap:wrap}
.swatch{width:34px;height:34px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .18s}
.swatch.on{border-color:#fff;transform:scale(1.18)}
#startBtn{width:100%;padding:17px;margin-top:6px;background:#fff;color:#000;border:none;border-radius:9px;font-family:'Orbitron',sans-serif;font-size:15px;font-weight:700;letter-spacing:4px;cursor:pointer;transition:all .18s}
#startBtn:hover{background:#ddd}
#startBtn:active{transform:scale(.98)}
.back-lnk{margin-top:14px;display:block;text-align:center;padding:11px 28px;border:1px solid #222;color:#555;border-radius:8px;font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:3px;text-decoration:none;transition:all .2s;width:min(480px,92vw)}
.back-lnk:hover{border-color:#555;color:#aaa}

/* â”€â”€ COUNTDOWN â”€â”€ */
#cd{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:150;font-family:'Black Ops One',cursive;font-size:clamp(90px,22vw,180px);text-shadow:0 0 50px currentColor;pointer-events:none}

/* â”€â”€ HUD â”€â”€ */
#hud{position:fixed;inset:0;pointer-events:none;z-index:30;display:none}
.hpanel{position:absolute;background:rgba(0,0,0,0.62);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.11);border-radius:11px;padding:11px 16px}
#htl{top:14px;left:14px}
#hspd{font-size:clamp(30px,5.5vw,48px);font-weight:900;line-height:1;letter-spacing:-1px}
#hunit{font-size:9px;color:#666;letter-spacing:3px;margin-top:2px}
#htr{top:14px;right:14px;text-align:right}
#hlap{font-size:clamp(12px,2vw,16px);color:#aaa;letter-spacing:2px;margin-bottom:2px}
#hpos{font-size:clamp(32px,5.5vw,50px);font-weight:900;line-height:1}
#hpsuf{font-size:13px;color:#777}
#hmsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Black Ops One',cursive;font-size:clamp(22px,4vw,38px);letter-spacing:3px;opacity:0;transition:opacity .3s;text-shadow:0 0 30px rgba(255,255,255,0.5);white-space:nowrap}
#hpause{bottom:14px;left:14px;font-size:9px;letter-spacing:2px;color:#444;padding:8px 14px}

/* â”€â”€ MINIMAP â”€â”€ */
#minimap{position:fixed;bottom:14px;right:14px;z-index:30;display:none;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.15)}

/* â”€â”€ TOUCH CONTROLS â”€â”€ */
#tc{position:fixed;bottom:0;left:0;right:0;height:220px;z-index:35;display:none;pointer-events:none}
.jzone{position:absolute;bottom:24px;left:24px;width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.18);pointer-events:all;touch-action:none}
.jknob{position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.28);border:2px solid rgba(255,255,255,0.5);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;transition:none}
.abts{position:absolute;bottom:24px;right:24px;display:flex;flex-direction:column;gap:12px;pointer-events:all}
.abt{width:68px;height:68px;border-radius:50%;background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;font-size:10px;letter-spacing:1px;color:rgba(255,255,255,0.5);user-select:none;touch-action:none}
.abt.on{background:rgba(255,255,255,0.28);border-color:rgba(255,255,255,0.7)}

/* â”€â”€ RESULT â”€â”€ */
#result{position:fixed;inset:0;background:rgba(0,0,0,0.93);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:200;padding:20px;overflow-y:auto}
#result h1{font-family:'Black Ops One',cursive;font-size:clamp(28px,5vw,52px);margin-bottom:6px}
.rpos{font-size:clamp(64px,16vw,128px);font-weight:900;line-height:1;margin:8px 0}
.rsub{font-size:11px;letter-spacing:5px;color:#666;margin-bottom:24px}
.rtable{width:min(420px,92vw);margin:12px 0}
.rrow{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.07)}
.rrow:first-child{border-top:1px solid rgba(255,255,255,0.07)}
.rbadge{width:22px;height:22px;border-radius:50%;background:#1a1a1a;display:flex;align-items:center;justify-content:center;font-size:10px;margin-right:10px;flex-shrink:0}
.rdot{width:11px;height:11px;border-radius:50%;margin-right:9px;flex-shrink:0}
.rname{flex:1;font-size:12px}
.rlaps{font-size:11px;color:#555}
.rrow.rme .rname{color:#fff}
.rrow.rme .rlaps{color:#aaa}
.rbtns{display:flex;gap:10px;margin-top:20px}
.rbtn{padding:13px 26px;background:transparent;border:1px solid #333;color:#666;border-radius:8px;font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:2px;cursor:pointer;text-decoration:none;transition:all .2s}
.rbtn:hover{border-color:#888;color:#bbb}
.rbtn.rpri{border-color:#fff;color:#fff;background:rgba(255,255,255,0.08)}
</style>
</head>
<body>

<!-- SETUP -->
<div id="setup">
  <h1>ğŸ RACE</h1>
  <p class="subtitle">PIXELON ARCADE</p>
  <div class="card">
    <div class="row">
      <label>Number of Cars</label>
      <div class="segs" id="sb-cars">
        <button class="seg" data-v="2">2</button>
        <button class="seg on" data-v="3">3</button>
        <button class="seg" data-v="4">4</button>
        <button class="seg" data-v="5">5</button>
        <button class="seg" data-v="6">6</button>
      </div>
    </div>
    <div class="row">
      <label>Your Car Colour</label>
      <div class="swatches" id="sw-color"></div>
    </div>
    <div class="row">
      <label>Number of Laps</label>
      <div class="segs" id="sb-laps">
        <button class="seg on" data-v="3">3</button>
        <button class="seg" data-v="5">5</button>
        <button class="seg" data-v="8">8</button>
        <button class="seg" data-v="10">10</button>
      </div>
    </div>
    <div class="row">
      <label>AI Difficulty</label>
      <div class="segs" id="sb-diff">
        <button class="seg on" data-v="0">Easy</button>
        <button class="seg" data-v="1">Medium</button>
        <button class="seg" data-v="2">Hard</button>
        <button class="seg" data-v="3">Extreme</button>
      </div>
    </div>
    <button id="startBtn">START RACE</button>
  </div>
  <a href="index.html" class="back-lnk">â† BACK</a>
</div>

<!-- CANVAS -->
<canvas id="gameCanvas"></canvas>

<!-- HUD -->
<div id="hud">
  <div class="hpanel" id="htl">
    <div id="hspd">0</div>
    <div id="hunit">KM/H</div>
  </div>
  <div class="hpanel" id="htr">
    <div id="hlap">LAP 1 / 3</div>
    <div id="hpos">1<span id="hpsuf">ST</span></div>
  </div>
  <div id="hmsg"></div>
  <div class="hpanel" id="hpause">ESC Â· PAUSE</div>
</div>

<!-- MINIMAP -->
<canvas id="minimap" width="148" height="148"></canvas>

<!-- TOUCH CONTROLS -->
<div id="tc">
  <div class="jzone" id="jzone"><div class="jknob" id="jknob"></div></div>
  <div class="abts">
    <div class="abt" id="btn-gas">GAS</div>
    <div class="abt" id="btn-brk">BRAKE</div>
  </div>
</div>

<!-- COUNTDOWN -->
<div id="cd"></div>

<!-- RESULT -->
<div id="result">
  <h1>RACE OVER</h1>
  <div class="rpos" id="rpos">1ST</div>
  <div class="rsub" id="rsub">YOU FINISHED</div>
  <div class="rtable" id="rtable"></div>
  <div class="rbtns">
    <button class="rbtn rpri" id="rrestart">RACE AGAIN</button>
    <a href="index.html" class="rbtn">â† BACK</a>
  </div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TW = 112;          // track width
const TN = 800;          // spline samples
const CL = 36, CW = 20; // car length, width
const CR = 22;           // collision radius
const MS = 7.8;          // max speed (units/frame)
const AC = 0.21;         // acceleration
const BK = 0.38;         // brake force
const FR = 0.976;        // rolling friction
const GS = 0.91;         // grass slowdown
const SR = 0.043;        // steer rate
const KMH = 28;          // speed â†’ km/h scale
const ZOOM = 2.35;
const NC = 12;           // checkpoint count
const WORLD_R = 1750;    // approx world radius

const COLORS = ['#FF2222','#2255FF','#22DD55','#FFD700','#FF44EE','#FF8811','#00DDDD','#FF6644'];
const SUF = ['','ST','ND','RD','TH','TH','TH'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cmr(p0,p1,p2,p3,t){
  const t2=t*t,t3=t2*t;
  return 0.5*((2*p1)+(-p0+p2)*t+(2*p0-5*p1+4*p2-p3)*t2+(-p0+3*p1-3*p2+p3)*t3);
}
function spline(pts,n){
  const L=pts.length,ps=Math.ceil(n/L),r=[];
  for(let i=0;i<L;i++){
    const p0=pts[(i-1+L)%L],p1=pts[i],p2=pts[(i+1)%L],p3=pts[(i+2)%L];
    for(let j=0;j<ps;j++){
      const t=j/ps;
      r.push({x:cmr(p0.x,p1.x,p2.x,p3.x,t),y:cmr(p0.y,p1.y,p2.y,p3.y,t)});
    }
  }
  return r;
}
function na(a){while(a>Math.PI)a-=Math.PI*2;while(a<-Math.PI)a+=Math.PI*2;return a;}
function d2(ax,ay,bx,by){return(ax-bx)**2+(ay-by)**2;}
function lighten(hex,a){
  const r=Math.max(0,Math.min(255,parseInt(hex.slice(1,3),16)+a));
  const g=Math.max(0,Math.min(255,parseInt(hex.slice(3,5),16)+a));
  const b=Math.max(0,Math.min(255,parseInt(hex.slice(5,7),16)+a));
  return `rgb(${r},${g},${b})`;
}

// Polyfill roundRect for older browsers
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    this.beginPath();this.moveTo(x+r,y);this.lineTo(x+w-r,y);
    this.arc(x+w-r,y+r,r,-Math.PI/2,0);this.lineTo(x+w,y+h-r);
    this.arc(x+w-r,y+h-r,r,0,Math.PI/2);this.lineTo(x+r,y+h);
    this.arc(x+r,y+h-r,r,Math.PI/2,Math.PI);this.lineTo(x,y+r);
    this.arc(x+r,y+r,r,Math.PI,-Math.PI/2);this.closePath();return this;
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Track {
  constructor(){
    this.pts=[];this.tang=[];this.cumL=[];this.totL=0;this.avgSeg=0;
    this.hash=new Map();this.cell=160;
    this.lEdge=[];this.rEdge=[];
    this.roadPath=null;this.lPath=null;this.rPath=null;
    this.finPt=null;this.finAng=0;this.startPos=[];
  }

  generate(){
    const N=14+Math.floor(Math.random()*4);
    const angs=[];
    for(let i=0;i<N;i++) angs.push((i/N)*Math.PI*2+(Math.random()-.5)*(Math.PI*2/N)*.5);
    angs.sort((a,b)=>a-b);
    const ctrl=angs.map(a=>({x:Math.cos(a)*(700+Math.random()*850),y:Math.sin(a)*(700+Math.random()*850)}));
    this.pts=spline(ctrl,TN);

    const n=this.pts.length;
    this.tang=new Float32Array(n);
    this.cumL=new Float32Array(n);
    let cum=0;
    for(let i=0;i<n;i++){
      const nx=(i+1)%n;
      const dx=this.pts[nx].x-this.pts[i].x,dy=this.pts[nx].y-this.pts[i].y;
      this.tang[i]=Math.atan2(dy,dx);
      this.cumL[i]=cum;
      cum+=Math.sqrt(dx*dx+dy*dy);
    }
    this.totL=cum;
    this.avgSeg=cum/n;

    const hw=TW/2;
    for(let i=0;i<n;i++){
      const t=this.tang[i];
      const nx2=-Math.sin(t)*hw,ny2=Math.cos(t)*hw;
      const p=this.pts[i];
      this.lEdge.push({x:p.x+nx2,y:p.y+ny2});
      this.rEdge.push({x:p.x-nx2,y:p.y-ny2});
    }

    this._buildPaths();
    this._buildHash();

    // Finish line (slightly past index 0 so cars start past it)
    const fi=15;
    this.finPt={...this.pts[fi]};
    this.finAng=this.tang[fi];
    this.startPos=this._startGrid(6);
  }

  _buildPaths(){
    const n=this.pts.length,p=this.pts;
    const mkPath=(arr)=>{
      const path=new Path2D();
      path.moveTo(arr[0].x,arr[0].y);
      for(let i=1;i<n;i++) path.lineTo(arr[i].x,arr[i].y);
      path.closePath();
      return path;
    };
    this.roadPath=mkPath(p);
    this.lPath=mkPath(this.lEdge);
    this.rPath=mkPath(this.rEdge);
  }

  _buildHash(){
    this.hash.clear();
    for(let i=0;i<this.pts.length;i++){
      const p=this.pts[i];
      const cx=Math.floor(p.x/this.cell),cy=Math.floor(p.y/this.cell);
      const k=cx*100000+cy;
      if(!this.hash.has(k))this.hash.set(k,[]);
      this.hash.get(k).push(i);
    }
  }

  nearestIdx(x,y){
    const cx=Math.floor(x/this.cell),cy=Math.floor(y/this.cell);
    let best=0,bd=Infinity;
    for(let dx=-2;dx<=2;dx++) for(let dy=-2;dy<=2;dy++){
      const b=this.hash.get((cx+dx)*100000+(cy+dy));
      if(!b)continue;
      for(const i of b){const p=this.pts[i];const dd=d2(x,y,p.x,p.y);if(dd<bd){bd=dd;best=i;}}
    }
    return best;
  }

  onTrack(x,y){
    const i=this.nearestIdx(x,y);const p=this.pts[i];
    return d2(x,y,p.x,p.y)<=(TW/2+14)**2;
  }

  progress(x,y){return this.nearestIdx(x,y)/this.pts.length;}

  ahead(x,y,dist){
    const si=this.nearestIdx(x,y);
    const steps=Math.round(dist/this.avgSeg);
    return this.pts[(si+steps)%this.pts.length];
  }

  curvature(x,y,dist){
    const si=this.nearestIdx(x,y);
    const steps=Math.max(1,Math.round(dist/this.avgSeg));
    let tot=0;
    for(let i=0;i<steps;i++){
      const a=this.tang[(si+i)%this.pts.length];
      const b=this.tang[(si+i+1)%this.pts.length];
      tot+=Math.abs(na(b-a));
    }
    return tot/steps;
  }

  _startGrid(n){
    const si=25; // start just past finish line
    const p=this.pts[si],t=this.tang[si];
    const bx=-Math.cos(t),by=-Math.sin(t); // backward
    const lx=-Math.sin(t),ly=Math.cos(t);  // lateral
    const res=[];
    for(let i=0;i<n;i++){
      const col=i%2,row=Math.floor(i/2);
      const lat=(col===0?1:-1)*TW*0.22;
      const lon=row*68+40;
      res.push({x:p.x+lx*lat+bx*lon,y:p.y+ly*lat+by*lon,angle:t});
    }
    return res;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Car {
  constructor(id,x,y,angle,color,isPlayer){
    this.id=id;this.x=x;this.y=y;this.angle=angle;this.color=color;this.isPlayer=isPlayer;
    this.speed=0;this.lat=0; // lateral (drift) velocity
    this.steer=0;this.thr=0; // inputs
    this.onTrack=true;
    this.tidx=0;
    this.prog=0;      // continuous (laps + fraction)
    this.laps=0;
    this.cpmask=0;    // checkpoint bitmask
    this.pos=1;
    this.finished=false;this.finTime=0;
    this.impT=0;      // impact flash timer
    this.name=isPlayer?'YOU':`CPU ${id}`;
    this.maxSpeed=MS;
  }

  update(dt,track,totalLaps){
    if(this.finished)return;
    const spd=this.speed,absSpd=Math.abs(spd);
    const sfact=Math.min(1,absSpd/2.2);

    // Steer (reversed when reversing)
    this.angle+=this.steer*SR*sfact*(spd<0?-1:1);

    // Throttle / brake / reverse
    if(this.thr>0){
      this.speed+=AC*this.thr;
    } else if(this.thr<0){
      if(this.speed>0.08){
        this.speed+=this.thr*BK;
      } else {
        this.speed+=this.thr*AC*0.5; // reverse
      }
    }

    const top=this.onTrack?this.maxSpeed:this.maxSpeed*0.55;
    this.speed=Math.max(-this.maxSpeed*0.38,Math.min(top,this.speed));

    const fric=this.onTrack?FR:GS;
    this.speed*=fric;
    this.lat*=0.80;
    if(Math.abs(this.speed)<0.008)this.speed=0;
    if(Math.abs(this.lat)<0.008)this.lat=0;

    const cos=Math.cos(this.angle),sin=Math.sin(this.angle);
    const lcos=Math.cos(this.angle+Math.PI/2),lsin=Math.sin(this.angle+Math.PI/2);
    this.x+=cos*this.speed+lcos*this.lat;
    this.y+=sin*this.speed+lsin*this.lat;

    this.onTrack=track.onTrack(this.x,this.y);
    this.tidx=track.nearestIdx(this.x,this.y);

    this._lapCheck(track,totalLaps);
    if(this.impT>0)this.impT--;
  }

  _lapCheck(track,totalLaps){
    const n=track.pts.length;
    const cur=this.tidx/n;
    const prev=this.prog%1;

    // Collect checkpoints (indices 1..NC-1)
    const ci=Math.floor(cur*NC);
    if(ci>0&&ci<NC)this.cpmask|=(1<<ci);

    // Lap complete: crossed finish going forward, all checkpoints passed
    const need=((1<<NC)-1)&~1; // bits 1..NC-1
    if(prev>0.88&&cur<0.12&&(this.cpmask&need)===need){
      this.laps++;
      this.cpmask=0;
      if(this.laps>=totalLaps){
        this.finished=true;
        this.finTime=performance.now();
      }
    }
    this.prog=this.laps+cur;
  }

  draw(ctx){
    const hl=CL/2,hw=CW/2;
    ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.angle);

    // Drop shadow
    ctx.save();ctx.translate(3,6);ctx.globalAlpha=0.35;
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.roundRect(-hl,-hw,CL,CW,6);ctx.fill();
    ctx.restore();

    // Flash on impact
    if(this.impT>0&&(this.impT%5)<3){
      ctx.fillStyle='rgba(255,255,255,0.9)';
      ctx.beginPath();ctx.roundRect(-hl,-hw,CL,CW,6);ctx.fill();
    } else {
      // Body gradient
      const g=ctx.createLinearGradient(-hl,-hw,hl,hw);
      g.addColorStop(0,lighten(this.color,45));
      g.addColorStop(.45,this.color);
      g.addColorStop(1,lighten(this.color,-50));
      ctx.fillStyle=g;
      ctx.beginPath();ctx.roundRect(-hl,-hw,CL,CW,6);ctx.fill();

      // Roof panel (slight darkening)
      ctx.fillStyle='rgba(0,0,0,0.2)';
      ctx.beginPath();ctx.roundRect(-hl+5,-hw+4,CL-10,CW-8,3);ctx.fill();

      // Windshield front
      ctx.fillStyle='rgba(150,220,255,0.62)';
      ctx.beginPath();ctx.roundRect(hl*0.05,-hw*0.56,hl*0.56,CW*0.56,3);ctx.fill();

      // Rear window
      ctx.fillStyle='rgba(150,220,255,0.35)';
      ctx.beginPath();ctx.roundRect(-hl*0.62,-hw*0.5,hl*0.36,hw,2);ctx.fill();

      // Stripe accent
      ctx.fillStyle='rgba(255,255,255,0.18)';
      ctx.fillRect(-hl+4,-1.5,CL-8,3);
    }

    // Wheels (4 corners)
    ctx.fillStyle='#111';
    [[hl*.62,hw+2],[hl*.62,-(hw+2)],[-hl*.62,hw+2],[-hl*.62,-(hw+2)]].forEach(([wx,wy])=>{
      ctx.beginPath();ctx.roundRect(wx-6,wy-3.2,12,6.4,2);ctx.fill();
      // Tyre highlight
      ctx.fillStyle='rgba(60,60,60,0.8)';
      ctx.beginPath();ctx.roundRect(wx-5,wy-2.5,10,5,1.5);ctx.fill();
      ctx.fillStyle='#111';
    });

    ctx.restore();

    // Name tag
    if(!this.isPlayer){
      ctx.save();ctx.translate(this.x,this.y-hw-20);
      ctx.font='bold 10px Orbitron,sans-serif';ctx.textAlign='center';
      ctx.fillStyle='rgba(0,0,0,0.55)';ctx.fillRect(-18,-11,36,13);
      ctx.fillStyle='rgba(255,255,255,0.6)';ctx.fillText(this.name,0,0);
      ctx.restore();
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class AI {
  constructor(car,diff){
    this.car=car;
    const d=Math.min(3,diff);
    this.spdM=[.60,.74,.87,.97][d];
    this.lookD=[85,125,175,235][d];
    this.err=[.38,.20,.07,.01][d];
    this.interval=[3,2,1,1][d];
    this.fc=Math.floor(Math.random()*4);
    car.maxSpeed=MS*this.spdM;
  }

  update(track){
    if(this.car.finished)return;
    if(++this.fc%this.interval!==0)return;
    const c=this.car;

    // Off track: recover
    if(!c.onTrack){
      const np=track.pts[c.tidx];
      const dx=np.x-c.x,dy=np.y-c.y;
      const ta=Math.atan2(dy,dx);
      const diff=na(ta-c.angle);
      c.steer=Math.max(-1,Math.min(1,diff*2.8));
      c.thr=.55;
      return;
    }

    // Dynamic look-ahead based on speed
    const ld=this.lookD+Math.abs(c.speed)*14;
    let tgt=track.ahead(c.x,c.y,ld);
    const e=this.err*55;
    tgt={x:tgt.x+(Math.random()-.5)*e,y:tgt.y+(Math.random()-.5)*e};

    const dx=tgt.x-c.x,dy=tgt.y-c.y;
    const diff=na(Math.atan2(dy,dx)-c.angle);
    c.steer=Math.max(-1,Math.min(1,diff*2.4));

    const curv=track.curvature(c.x,c.y,180);
    if(curv>.016)       c.thr=-0.25;
    else if(curv>.009)  c.thr=0.45;
    else                c.thr=1.0;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Input {
  constructor(){
    this.L=false;this.R=false;this.gas=false;this.brk=false;
    this.joyX=0;this.jid=null;this.jbx=0;this.jby=0;
    this.gid=null;this.bid=null;
    this._kb();this._touch();
  }
  _kb(){
    const dn=e=>{
      if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A')this.L=true;
      if(e.key==='ArrowRight'||e.key==='d'||e.key==='D')this.R=true;
      if(e.key==='ArrowUp'||e.key==='w'||e.key==='W')this.gas=true;
      if(e.key==='ArrowDown'||e.key==='s'||e.key==='S')this.brk=true;
    };
    const up=e=>{
      if(e.key==='ArrowLeft'||e.key==='a'||e.key==='A')this.L=false;
      if(e.key==='ArrowRight'||e.key==='d'||e.key==='D')this.R=false;
      if(e.key==='ArrowUp'||e.key==='w'||e.key==='W')this.gas=false;
      if(e.key==='ArrowDown'||e.key==='s'||e.key==='S')this.brk=false;
    };
    document.addEventListener('keydown',dn);
    document.addEventListener('keyup',up);
  }
  _touch(){
    const jz=document.getElementById('jzone');
    const jk=document.getElementById('jknob');
    const gb=document.getElementById('btn-gas');
    const bb=document.getElementById('btn-brk');
    if(!jz)return;
    const maxJ=42;

    jz.addEventListener('touchstart',e=>{
      e.preventDefault();
      const t=e.changedTouches[0];
      if(this.jid===null){
        this.jid=t.identifier;
        const r=jz.getBoundingClientRect();
        this.jbx=r.left+r.width/2;this.jby=r.top+r.height/2;
        this._jUpdate(t.clientX,jk,maxJ);
      }
    },{passive:false});

    document.addEventListener('touchmove',e=>{
      e.preventDefault();
      for(const t of e.changedTouches){
        if(t.identifier===this.jid)this._jUpdate(t.clientX,jk,maxJ);
      }
    },{passive:false});

    document.addEventListener('touchend',e=>{
      for(const t of e.changedTouches){
        if(t.identifier===this.jid){this.jid=null;this.joyX=0;jk.style.transform='translate(-50%,-50%)';}
        if(t.identifier===this.gid){this.gid=null;this.gas=false;gb.classList.remove('on');}
        if(t.identifier===this.bid){this.bid=null;this.brk=false;bb.classList.remove('on');}
      }
    });

    gb.addEventListener('touchstart',e=>{
      e.preventDefault();const t=e.changedTouches[0];
      if(this.gid===null){this.gid=t.identifier;this.gas=true;gb.classList.add('on');}
    },{passive:false});

    bb.addEventListener('touchstart',e=>{
      e.preventDefault();const t=e.changedTouches[0];
      if(this.bid===null){this.bid=t.identifier;this.brk=true;bb.classList.add('on');}
    },{passive:false});
  }
  _jUpdate(cx,knob,maxJ){
    const dx=cx-this.jbx;
    const clamped=Math.max(-maxJ,Math.min(maxJ,dx));
    this.joyX=clamped/maxJ;
    knob.style.transform=`translate(calc(-50% + ${clamped}px),-50%)`;
  }
  steerVal(){return this.jid!==null?this.joyX:(this.R?1:0)-(this.L?1:0);}
  thrVal(){return this.gas&&!this.brk?1:this.brk&&!this.gas?-1:0;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawBg(ctx,w,h,cam){
  // Scrolling grass grid
  const grad=ctx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0,'#183809');grad.addColorStop(1,'#274d12');
  ctx.fillStyle=grad;ctx.fillRect(0,0,w,h);

  ctx.strokeStyle='rgba(35,80,18,0.35)';ctx.lineWidth=1;
  const gs=90;
  const ox=(((-cam.x*ZOOM)%gs)+gs*2)%gs;
  const oy=(((-cam.y*ZOOM)%gs)+gs*2)%gs;
  for(let x=ox-gs;x<w+gs;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let y=oy-gs;y<h+gs;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
}

function drawTrack(ctx,track){
  ctx.lineJoin='round';ctx.lineCap='round';

  // Runoff (wider dark green)
  ctx.lineWidth=TW+26;ctx.strokeStyle='#1c3d0e';
  ctx.stroke(track.roadPath);

  // Asphalt base
  ctx.lineWidth=TW;ctx.strokeStyle='#2a2a2a';
  ctx.stroke(track.roadPath);

  // Road surface
  ctx.lineWidth=TW-6;ctx.strokeStyle='#313131';
  ctx.stroke(track.roadPath);

  // Centre dashes
  ctx.lineWidth=2;ctx.strokeStyle='rgba(255,210,0,0.65)';
  ctx.setLineDash([24,20]);ctx.stroke(track.roadPath);ctx.setLineDash([]);

  // White edge lines
  ctx.lineWidth=3;ctx.strokeStyle='rgba(255,255,255,0.5)';
  ctx.stroke(track.lPath);ctx.stroke(track.rPath);

  // Finish line
  const p=track.finPt,ang=track.finAng;
  const blks=8,bw=TW/blks,bh=15;
  ctx.save();ctx.translate(p.x,p.y);ctx.rotate(ang+Math.PI/2);
  for(let i=0;i<blks;i++){
    for(let r=0;r<2;r++){
      ctx.fillStyle=(i+r)%2===0?'#fff':'#000';
      ctx.fillRect(-TW/2+i*bw,r*bh-bh,bw,bh);
    }
  }
  // FINISH text above line
  ctx.font='bold 11px Orbitron,sans-serif';ctx.textAlign='center';
  ctx.fillStyle='rgba(255,255,255,0.7)';ctx.fillText('FINISH',0,-bh-4);
  ctx.restore();
}

function drawMinimap(mc,track,cars){
  const s=148;
  mc.clearRect(0,0,s,s);
  mc.fillStyle='rgba(0,0,0,0.72)';
  mc.beginPath();mc.roundRect(0,0,s,s,10);mc.fill();

  const sc=(s*.42)/WORLD_R,cx=s/2,cy=s/2;

  // Track outline
  mc.lineWidth=5;mc.strokeStyle='#444';
  mc.beginPath();
  track.pts.forEach((p,i)=>{
    const x=cx+p.x*sc,y=cy+p.y*sc;
    i===0?mc.moveTo(x,y):mc.lineTo(x,y);
  });
  mc.closePath();mc.stroke();

  // Finish dot
  mc.fillStyle='#fff';mc.beginPath();
  mc.arc(cx+track.finPt.x*sc,cy+track.finPt.y*sc,4,0,Math.PI*2);mc.fill();

  // Cars
  for(const c of cars){
    mc.fillStyle=c.color;
    mc.beginPath();
    mc.arc(cx+c.x*sc,cy+c.y*sc,c.isPlayer?5.5:3.5,0,Math.PI*2);
    mc.fill();
    if(c.isPlayer){mc.strokeStyle='#fff';mc.lineWidth=1.5;mc.stroke();}
  }

  // Border
  mc.strokeStyle='rgba(255,255,255,0.15)';mc.lineWidth=1;
  mc.beginPath();mc.roundRect(0,0,s,s,10);mc.stroke();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Game {
  constructor(cfg){
    this.cfg=cfg;
    this.canvas=document.getElementById('gameCanvas');
    this.ctx=this.canvas.getContext('2d');
    this.mc=document.getElementById('minimap').getContext('2d');
    this.track=new Track();
    this.cars=[];this.ais=[];this.player=null;
    this.inp=new Input();
    this.cam={x:0,y:0};
    this.phase='cd'; // cd|race|done
    this.lastT=0;this.aid=null;
    this.msgTimer=0;
  }

  start(){
    this._resize();
    window.addEventListener('resize',()=>this._resize());

    // Generate track
    this.track.generate();

    // Shuffle start positions
    const numC=this.cfg.cars;
    const order=Array.from({length:numC},(_,i)=>i);
    for(let i=order.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[order[i],order[j]]=[order[j],order[i]];}

    // Colours: player picks, AI gets spread rest
    const avail=COLORS.filter(c=>c!==this.cfg.color);

    for(let i=0;i<numC;i++){
      const gi=order[i];
      const sp=this.track.startPos[gi];
      const isP=i===0;
      const col=isP?this.cfg.color:avail[(i-1)%avail.length];
      const car=new Car(i,sp.x,sp.y,sp.angle,col,isP);
      car.tidx=this.track.nearestIdx(car.x,car.y);
      if(isP){this.player=car;this.cam.x=car.x;this.cam.y=car.y;}
      else this.ais.push(new AI(car,this.cfg.diff));
      this.cars.push(car);
    }

    if('ontouchstart' in window) document.getElementById('tc').style.display='block';
    document.getElementById('hud').style.display='block';
    document.getElementById('minimap').style.display='block';

    this._countdown();
  }

  _countdown(){
    let v=3;
    const el=document.getElementById('cd');
    el.style.display='flex';
    const tick=()=>{
      if(v>0){
        el.textContent=v;
        el.style.color=['#FF4444','#FFAA00','#55FF55'][v-1];
        v--;setTimeout(tick,900);
      } else {
        el.textContent='GO!';el.style.color='#fff';
        this.phase='race';
        this.lastT=performance.now();
        setTimeout(()=>{el.style.display='none';},700);
        this.aid=requestAnimationFrame(t=>this._loop(t));
      }
    };
    tick();
  }

  _loop(ts){
    this.aid=requestAnimationFrame(t=>this._loop(t));
    const dt=Math.min((ts-this.lastT)/16.67,3);
    this.lastT=ts;
    if(this.phase==='race')this._update(dt);
    this._render();
  }

  _update(dt){
    const p=this.player;
    if(!p.finished){p.steer=this.inp.steerVal();p.thr=this.inp.thrVal();}

    for(const ai of this.ais)ai.update(this.track);
    for(const c of this.cars)c.update(dt,this.track,this.cfg.laps);

    this._collide();
    this._positions();

    // Camera: smooth + lead
    const lead=75;
    const tx=p.x+Math.cos(p.angle)*lead;
    const ty=p.y+Math.sin(p.angle)*lead;
    this.cam.x+=(tx-this.cam.x)*.072;
    this.cam.y+=(ty-this.cam.y)*.072;

    this._hudUpdate();

    if(p.finished&&this.phase==='race'){
      this.phase='done';
      this._showMsg(p.pos===1?'ğŸ† WINNER!':'FINISHED '+p.pos+SUF[Math.min(p.pos,6)]);
      setTimeout(()=>this._result(),2200);
    }
  }

  _collide(){
    const C=this.cars;
    for(let i=0;i<C.length;i++) for(let j=i+1;j<C.length;j++){
      const a=C[i],b=C[j];
      const dx=b.x-a.x,dy=b.y-a.y;
      const dsq=dx*dx+dy*dy;
      const mn=CR*2;
      if(dsq>=mn*mn||dsq<.01)continue;
      const dist=Math.sqrt(dsq);
      const nx=dx/dist,ny=dy/dist;
      const ov=(mn-dist)*.52;
      a.x-=nx*ov;a.y-=ny*ov;
      b.x+=nx*ov;b.y+=ny*ov;

      // Speed along collision normal
      const aN=(Math.cos(a.angle)*nx+Math.sin(a.angle)*ny)*a.speed;
      const bN=(Math.cos(b.angle)*nx+Math.sin(b.angle)*ny)*b.speed;
      if(aN-bN>0.15){
        const imp=(aN-bN)*.68;
        a.speed-=imp*.62;b.speed+=imp*.62;
        // Lateral drift
        const tx2=-ny,ty2=nx;
        const aD=Math.cos(a.angle)*tx2+Math.sin(a.angle)*ty2;
        const bD=Math.cos(b.angle)*tx2+Math.sin(b.angle)*ty2;
        a.lat+=imp*.55*aD;b.lat-=imp*.55*bD;
        a.impT=14;b.impT=14;
      }
    }
  }

  _positions(){
    [...this.cars].sort((a,b)=>b.prog-a.prog).forEach((c,i)=>c.pos=i+1);
  }

  _hudUpdate(){
    const p=this.player;
    document.getElementById('hspd').textContent=Math.round(Math.abs(p.speed)*KMH);
    const lap=Math.min(p.laps+1,this.cfg.laps);
    document.getElementById('hlap').textContent=`LAP ${lap} / ${this.cfg.laps}`;
    const s=SUF[Math.min(p.pos,6)];
    document.getElementById('hpos').innerHTML=`${p.pos}<span id="hpsuf">${s}</span>`;
  }

  _showMsg(txt){
    const el=document.getElementById('hmsg');
    el.textContent=txt;el.style.opacity='1';
    setTimeout(()=>el.style.opacity='0',2000);
  }

  _render(){
    const ctx=this.ctx,cv=this.canvas;
    ctx.clearRect(0,0,cv.width,cv.height);
    drawBg(ctx,cv.width,cv.height,this.cam);

    ctx.save();
    ctx.translate(cv.width/2,cv.height/2);
    ctx.scale(ZOOM,ZOOM);
    ctx.translate(-this.cam.x,-this.cam.y);

    drawTrack(ctx,this.track);

    // Draw cars back-to-front by y
    [...this.cars].sort((a,b)=>a.y-b.y).forEach(c=>c.draw(ctx));

    ctx.restore();

    drawMinimap(this.mc,this.track,this.cars);
  }

  _resize(){
    this.canvas.width=window.innerWidth;
    this.canvas.height=window.innerHeight;
  }

  _result(){
    const p=this.player;
    const pos=p.pos;
    const labels=['ğŸ† YOU WON!','SO CLOSE!','ON THE PODIUM!','RACE COMPLETE','RACE COMPLETE','RACE COMPLETE'];
    document.getElementById('rpos').textContent=pos+(SUF[Math.min(pos,6)]);
    document.getElementById('rsub').textContent=labels[Math.min(pos-1,5)];

    const sorted=[...this.cars].sort((a,b)=>b.prog-a.prog);
    document.getElementById('rtable').innerHTML=sorted.map((c,i)=>`
      <div class="rrow ${c.isPlayer?'rme':''}">
        <div style="display:flex;align-items:center">
          <div class="rbadge">${i+1}</div>
          <div class="rdot" style="background:${c.color}"></div>
          <span class="rname">${c.name}</span>
        </div>
        <span class="rlaps">${c.laps}/${this.cfg.laps} laps</span>
      </div>`).join('');

    document.getElementById('result').style.display='flex';
    if(this.aid)cancelAnimationFrame(this.aid);
  }

  stop(){if(this.aid)cancelAnimationFrame(this.aid);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI / SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G=null;
const cfg={cars:3,color:COLORS[0],laps:3,diff:0};

// Colour swatches
const swC=document.getElementById('sw-color');
COLORS.forEach((c,i)=>{
  const s=document.createElement('div');
  s.className='swatch'+(i===0?' on':'');
  s.style.background=c;
  s.onclick=()=>{
    document.querySelectorAll('.swatch').forEach(x=>x.classList.remove('on'));
    s.classList.add('on');cfg.color=c;
  };
  swC.appendChild(s);
});

// Segmented buttons helper
const segs=(id,key)=>{
  document.getElementById(id).querySelectorAll('.seg').forEach(b=>{
    b.onclick=()=>{
      document.getElementById(id).querySelectorAll('.seg').forEach(x=>x.classList.remove('on'));
      b.classList.add('on');
      cfg[key]=isNaN(+b.dataset.v)?b.dataset.v:+b.dataset.v;
    };
  });
};
segs('sb-cars','cars');segs('sb-laps','laps');segs('sb-diff','diff');

document.getElementById('startBtn').onclick=()=>{
  document.getElementById('setup').style.display='none';
  if(G)G.stop();
  G=new Game({...cfg});
  G.start();
};

document.getElementById('rrestart').onclick=()=>{
  document.getElementById('result').style.display='none';
  document.getElementById('setup').style.display='flex';
  document.getElementById('hud').style.display='none';
  document.getElementById('minimap').style.display='none';
  document.getElementById('tc').style.display='none';
};

// ESC to return to menu during race
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'&&G&&G.phase!=='cd'){
    G.stop();
    document.getElementById('result').style.display='none';
    document.getElementById('setup').style.display='flex';
    document.getElementById('hud').style.display='none';
    document.getElementById('minimap').style.display='none';
    document.getElementById('tc').style.display='none';
  }
});
</script>
</body>
</html>
